<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Zucca Café</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        .tab-active { border-bottom: 3px solid #3B82F6; color: #3B82F6; }
        .task-item { transition: background-color 0.15s, box-shadow 0.15s; }
        /* Product name truncation */
        .product-name {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* Prevent selection on quantity buttons */
        .qty-btn {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="px-4 py-3">
            <h1 id="location-name" class="text-xl font-bold text-gray-800 text-center">Zucca Café</h1>
            <!-- Location Switcher -->
            <div class="flex justify-center gap-2 mt-2">
                <button class="location-btn px-3 py-1 rounded-full text-sm font-medium bg-blue-600 text-white"
                        data-location="isgav" onclick="switchLocation('isgav')">
                    Isgav
                </button>
                <button class="location-btn px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-700"
                        data-location="frankfurt" onclick="switchLocation('frankfurt')">
                    Frankfurt
                </button>
            </div>
        </div>
        <!-- Tabs -->
        <div class="flex border-b">
            <button id="tab-inventory" class="flex-1 py-3 text-center font-medium tab-active" onclick="switchTab('inventory')">
                Inventory Check
            </button>
            <button id="tab-tasks" class="flex-1 py-3 text-center font-medium text-gray-500" onclick="switchTab('tasks')">
                Daily Tasks
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pb-24 px-2">
        <!-- Inventory Tab -->
        <div id="inventory-tab" class="py-2">
            <!-- Add Category -->
            <div class="bg-white rounded-lg shadow p-3 mb-3">
                <div class="flex gap-2">
                    <input type="text" id="new-category" placeholder="New category name..."
                           class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="addCategory()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600">
                        + Add
                    </button>
                </div>
            </div>

            <!-- Categories Container -->
            <div id="categories-container"></div>

            <!-- Generate Order Button -->
            <div class="mt-4">
                <button onclick="generateOrder()" class="w-full bg-amber-500 text-white py-3 rounded-lg font-bold hover:bg-amber-600 flex items-center justify-center gap-2">
                    Generate Order List
                </button>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks-tab" class="py-2 hidden">
            <!-- Add Task List -->
            <div class="bg-white rounded-lg shadow p-3 mb-3">
                <div class="flex gap-2">
                    <input type="text" id="new-task-list" placeholder="New task list (e.g., Opening Shift)..."
                           class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="addTaskList()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600">
                        + Add
                    </button>
                </div>
            </div>

            <!-- Task Lists Container -->
            <div id="task-lists-container"></div>

            <!-- Task Actions -->
            <div class="mt-4">
                <button onclick="shareAllTasks()" class="w-full bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">
                    Share All Tasks
                </button>
            </div>
        </div>
    </main>

    <!-- Order Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Missing Items Order</h2>
                <button onclick="closeModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <pre id="order-text" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap"></pre>
            </div>
            <div class="p-4 border-t flex gap-2">
                <button onclick="copyOrder()" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium hover:bg-gray-300">
                    Copy
                </button>
                <button onclick="shareViaWhatsApp()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600">
                    WhatsApp
                </button>
                <button onclick="shareViaEmail()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600">
                    Email
                </button>
            </div>
        </div>
    </div>

    <!-- Select Tasks Modal -->
    <div id="select-tasks-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Select Lists to Share</h2>
                <button onclick="closeSelectModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div id="task-list-checkboxes" class="space-y-3"></div>
            </div>
            <div class="p-4 border-t flex gap-2">
                <button onclick="closeSelectModal()" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium hover:bg-gray-300">
                    Cancel
                </button>
                <button onclick="shareSelectedTasks()" class="flex-1 bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">
                    Share Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Share Task List</h2>
                <button onclick="closeShareModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <pre id="share-text" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap"></pre>
            </div>
            <div class="p-4 border-t flex gap-2">
                <button onclick="copyTaskList()" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium hover:bg-gray-300">
                    Copy
                </button>
                <button onclick="shareTasksWhatsApp()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600">
                    WhatsApp
                </button>
                <button onclick="shareTasksEmail()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600">
                    Email
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBG8XLW_A0mah5B6E-1EPf9DvA96ym6Xgg",
            authDomain: "zucca-mang.firebaseapp.com",
            projectId: "zucca-mang",
            storageBucket: "zucca-mang.firebasestorage.app",
            messagingSenderId: "423632065920",
            appId: "1:423632065920:web:43c340defd3fe33442dd65"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Location Configuration
        const locations = [
            { id: 'isgav', name: 'Zucca Isgav' },
            { id: 'frankfurt', name: 'Zucca Frankfurt' }
        ];
        let currentLocation = localStorage.getItem('currentLocation') || 'isgav';
        let unsubscribe = null;

        // Data State
        let state = {
            categories: [],
            taskLists: []
        };

        // UI State (not saved to Firebase)
        let expandedCategories = [];
        let expandedTaskLists = [];

        // Switch Location
        function switchLocation(locationId) {
            if (unsubscribe) unsubscribe();
            currentLocation = locationId;
            localStorage.setItem('currentLocation', locationId);
            expandedCategories = [];
            expandedTaskLists = [];
            updateLocationUI();
            loadState();
        }

        function updateLocationUI() {
            const locationName = locations.find(l => l.id === currentLocation)?.name || 'Zucca';
            document.getElementById('location-name').textContent = locationName;
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.toggle('bg-blue-600', btn.dataset.location === currentLocation);
                btn.classList.toggle('text-white', btn.dataset.location === currentLocation);
                btn.classList.toggle('bg-gray-200', btn.dataset.location !== currentLocation);
                btn.classList.toggle('text-gray-700', btn.dataset.location !== currentLocation);
            });
        }

        // Load from Firestore and listen for real-time updates
        function loadState() {
            unsubscribe = db.collection('locations').doc(currentLocation).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    state.categories = data.categories || [];
                    state.taskLists = data.taskLists || [];
                } else {
                    // First time - create initial empty data
                    state.categories = [];
                    state.taskLists = [];
                    saveState();
                }
                renderAll();
            }, (error) => {
                console.error("Error loading data:", error);
                // Fallback to empty state
                renderAll();
            });
        }

        // Save to Firestore
        function saveState() {
            db.collection('locations').doc(currentLocation).set({
                categories: state.categories,
                taskLists: state.taskLists
            }).catch((error) => {
                console.error("Error saving data:", error);
                alert("Error saving. Please check your connection.");
            });
        }

        // Tab Switching
        function switchTab(tab) {
            const inventoryTab = document.getElementById('inventory-tab');
            const tasksTab = document.getElementById('tasks-tab');
            const tabInventory = document.getElementById('tab-inventory');
            const tabTasks = document.getElementById('tab-tasks');

            if (tab === 'inventory') {
                inventoryTab.classList.remove('hidden');
                tasksTab.classList.add('hidden');
                tabInventory.classList.add('tab-active');
                tabInventory.classList.remove('text-gray-500');
                tabTasks.classList.remove('tab-active');
                tabTasks.classList.add('text-gray-500');
            } else {
                tasksTab.classList.remove('hidden');
                inventoryTab.classList.add('hidden');
                tabTasks.classList.add('tab-active');
                tabTasks.classList.remove('text-gray-500');
                tabInventory.classList.remove('tab-active');
                tabInventory.classList.add('text-gray-500');
            }
        }

        // Category Functions
        function toggleCategory(categoryId) {
            const index = expandedCategories.indexOf(categoryId);
            if (index === -1) {
                expandedCategories.push(categoryId);
            } else {
                expandedCategories.splice(index, 1);
            }
            renderCategories();
        }

        function addCategory() {
            const input = document.getElementById('new-category');
            const name = input.value.trim();
            if (!name) return;

            state.categories.push({
                id: Date.now(),
                name: name,
                products: []
            });
            input.value = '';
            saveState();
            renderCategories();
        }

        function deleteCategory(categoryId) {
            if (!confirm('Delete this category and all its products?')) return;
            state.categories = state.categories.filter(c => c.id !== categoryId);
            saveState();
            renderCategories();
        }

        // Product Functions
        function addProduct(categoryId) {
            const input = document.getElementById(`product-input-${categoryId}`);
            const name = input.value.trim();
            if (!name) return;

            const category = state.categories.find(c => c.id === categoryId);
            category.products.push({
                id: Date.now(),
                name: name,
                quantity: 0,
                unit: 'item'
            });
            input.value = '';
            saveState();
            renderCategories();
        }

        function incrementQuantity(categoryId, productId, amount = 1) {
            const category = state.categories.find(c => c.id === categoryId);
            const product = category.products.find(p => p.id === productId);
            product.quantity += amount;
            saveState();
            renderCategories();
        }

        function decrementQuantity(categoryId, productId, amount = 1) {
            const category = state.categories.find(c => c.id === categoryId);
            const product = category.products.find(p => p.id === productId);
            product.quantity = Math.max(0, product.quantity - amount);
            saveState();
            renderCategories();
        }

        // Long press handlers for +/- buttons
        let qtyLongPressTimer = null;
        let qtyLongPressed = false;

        function handleQtyTouchStart(e, categoryId, productId, isIncrement) {
            qtyLongPressed = false;
            qtyLongPressTimer = setTimeout(() => {
                qtyLongPressed = true;
                navigator.vibrate && navigator.vibrate(50);
                if (isIncrement) {
                    incrementQuantity(categoryId, productId, 5);
                } else {
                    decrementQuantity(categoryId, productId, 5);
                }
            }, 500);
        }

        function handleQtyTouchEnd(e, categoryId, productId, isIncrement) {
            if (qtyLongPressTimer) {
                clearTimeout(qtyLongPressTimer);
                qtyLongPressTimer = null;
            }
            if (!qtyLongPressed) {
                // Quick tap - add/remove 1
                if (isIncrement) {
                    incrementQuantity(categoryId, productId, 1);
                } else {
                    decrementQuantity(categoryId, productId, 1);
                }
            }
            qtyLongPressed = false;
        }

        function getStockStatus(quantity) {
            if (quantity === 0) return { label: 'OK', color: 'bg-green-100 text-green-700' };
            return { label: 'Need ' + quantity, color: 'bg-red-100 text-red-700' };
        }

        function deleteProduct(categoryId, productId) {
            const category = state.categories.find(c => c.id === categoryId);
            category.products = category.products.filter(p => p.id !== productId);
            saveState();
            renderCategories();
        }

        function resetCategory(categoryId) {
            const category = state.categories.find(c => c.id === categoryId);
            if (!category) return;
            category.products.forEach(p => p.quantity = 0);
            saveState();
            renderCategories();
        }

        function toggleProductUnit(categoryId, productId) {
            const category = state.categories.find(c => c.id === categoryId);
            const product = category.products.find(p => p.id === productId);
            if (product) {
                product.unit = product.unit === 'item' ? 'package' : 'item';
                saveState();
                renderCategories();
            }
        }

        // Color Options for Task Lists
        const taskListColors = {
            blue: { bg: 'bg-blue-600', progress: 'bg-blue-800', text: 'text-blue-200' },
            green: { bg: 'bg-green-600', progress: 'bg-green-800', text: 'text-green-200' },
            red: { bg: 'bg-red-600', progress: 'bg-red-800', text: 'text-red-200' },
            orange: { bg: 'bg-orange-500', progress: 'bg-orange-700', text: 'text-orange-200' },
            purple: { bg: 'bg-purple-600', progress: 'bg-purple-800', text: 'text-purple-200' },
            pink: { bg: 'bg-pink-500', progress: 'bg-pink-700', text: 'text-pink-200' },
            teal: { bg: 'bg-teal-600', progress: 'bg-teal-800', text: 'text-teal-200' },
            gray: { bg: 'bg-gray-600', progress: 'bg-gray-800', text: 'text-gray-300' }
        };

        // Task List Functions
        function toggleTaskList(listId) {
            const index = expandedTaskLists.indexOf(listId);
            if (index === -1) {
                expandedTaskLists.push(listId);
            } else {
                expandedTaskLists.splice(index, 1);
            }
            renderTaskLists();
        }

        function addTaskList() {
            const input = document.getElementById('new-task-list');
            const name = input.value.trim();
            if (!name) return;

            state.taskLists.push({
                id: Date.now(),
                name: name,
                color: 'blue',
                tasks: []
            });
            input.value = '';
            saveState();
            renderTaskLists();
        }

        function deleteTaskList(listId) {
            if (!confirm('Delete this task list and all its tasks?')) return;
            state.taskLists = state.taskLists.filter(l => l.id !== listId);
            saveState();
            renderTaskLists();
        }

        function changeTaskListColor(listId, color) {
            const taskList = state.taskLists.find(l => l.id === listId);
            if (taskList) {
                taskList.color = color;
                saveState();
                renderTaskLists();
            }
        }

        function addTask(listId) {
            const input = document.getElementById(`task-input-${listId}`);
            const text = input.value.trim();
            if (!text) return;

            const taskList = state.taskLists.find(l => l.id === listId);
            taskList.tasks.push({
                id: Date.now(),
                text: text,
                done: false
            });
            input.value = '';
            saveState();
            renderTaskLists();
        }

        function toggleTask(listId, taskId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            const task = taskList.tasks.find(t => t.id === taskId);
            task.done = !task.done;
            saveState();
            renderTaskLists();
        }

        function deleteTask(listId, taskId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            taskList.tasks = taskList.tasks.filter(t => t.id !== taskId);
            saveState();
            renderTaskLists();
        }

        // Edit task text
        function editTask(listId, taskId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            const task = taskList.tasks.find(t => t.id === taskId);
            const newText = prompt('Edit task:', task.text);
            if (newText !== null && newText.trim()) {
                task.text = newText.trim();
                saveState();
                renderTaskLists();
            }
        }

        // Drag and drop reorder (desktop)
        let draggedTask = null;
        let draggedListId = null;

        function handleDragStart(e, listId, taskId) {
            draggedTask = taskId;
            draggedListId = listId;
            e.target.closest('.task-item').classList.add('opacity-50');
        }

        function handleDragEnd(e) {
            e.target.closest('.task-item')?.classList.remove('opacity-50');
            draggedTask = null;
            draggedListId = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e, listId, targetTaskId) {
            e.preventDefault();
            if (draggedTask === null || draggedListId !== listId || draggedTask === targetTaskId) return;

            const taskList = state.taskLists.find(l => l.id === listId);
            const fromIndex = taskList.tasks.findIndex(t => t.id === draggedTask);
            const toIndex = taskList.tasks.findIndex(t => t.id === targetTaskId);

            if (fromIndex !== -1 && toIndex !== -1) {
                const [removed] = taskList.tasks.splice(fromIndex, 1);
                taskList.tasks.splice(toIndex, 0, removed);
                saveState();
                renderTaskLists();
            }
        }

        // Touch drag and drop (mobile)
        let touchDragElement = null;
        let touchDragListId = null;
        let touchDragTaskId = null;
        let touchStartY = 0;
        let touchTimeout = null;
        let isDragging = false;

        let touchStartX = 0;

        function initTouchDrag() {
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMoveCheck, { passive: true });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });
        }

        // Check if user is scrolling (cancel drag)
        function handleTouchMoveCheck(e) {
            if (!touchTimeout) return;
            if (!touchDragElement) return;

            const moveX = Math.abs(e.touches[0].clientX - touchStartX);
            const moveY = Math.abs(e.touches[0].clientY - touchStartY);

            // If moved more than 10px, user is scrolling - cancel drag
            if (moveX > 10 || moveY > 10) {
                clearTimeout(touchTimeout);
                touchTimeout = null;
                touchDragElement = null;
            }
        }

        function handleTouchStart(e) {
            // Check if touch is on a task item
            const taskItem = e.target.closest('.task-item');
            if (!taskItem) return;

            // Don't interfere with checkbox or delete button
            if (e.target.closest('.task-checkbox') || e.target.closest('.task-delete')) {
                return;
            }

            touchDragListId = parseInt(taskItem.dataset.listId);
            touchDragTaskId = parseInt(taskItem.dataset.taskId);
            touchDragElement = taskItem;
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;

            // Start drag after holding for 500ms without moving
            touchTimeout = setTimeout(() => {
                isDragging = true;
                taskItem.classList.add('bg-blue-100', 'shadow-lg', 'z-50', 'border-l-4', 'border-blue-500');
                navigator.vibrate && navigator.vibrate(100); // Longer vibration to confirm drag mode
                // Now add the drag move listener
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
            }, 500);
        }

        function handleTouchMove(e) {
            if (!isDragging || !touchDragTaskId) return;

            e.preventDefault();

            const touchY = e.touches[0].clientY;

            // Find current dragged element (may have changed after re-render)
            const currentElement = document.querySelector(`.task-item[data-task-id="${touchDragTaskId}"][data-list-id="${touchDragListId}"]`);
            if (!currentElement) return;

            const container = currentElement.closest('.task-list-container');
            const taskItems = Array.from(container.querySelectorAll('.task-item'));

            for (const item of taskItems) {
                const itemTaskId = parseInt(item.dataset.taskId);
                if (itemTaskId === touchDragTaskId) continue;

                const rect = item.getBoundingClientRect();
                const middle = rect.top + rect.height / 2;

                // Check if finger is over this item
                if (touchY > rect.top && touchY < rect.bottom) {
                    const taskList = state.taskLists.find(l => l.id === touchDragListId);
                    const fromIndex = taskList.tasks.findIndex(t => t.id === touchDragTaskId);
                    const toIndex = taskList.tasks.findIndex(t => t.id === itemTaskId);

                    // Only swap if moving in the right direction
                    if ((fromIndex < toIndex && touchY > middle) || (fromIndex > toIndex && touchY < middle)) {
                        reorderTasks(touchDragListId, touchDragTaskId, itemTaskId);
                        // Re-highlight the dragged element after re-render
                        setTimeout(() => {
                            const newElement = document.querySelector(`.task-item[data-task-id="${touchDragTaskId}"][data-list-id="${touchDragListId}"]`);
                            if (newElement) {
                                newElement.classList.add('bg-blue-100', 'shadow-lg', 'z-50', 'border-l-4', 'border-blue-500');
                            }
                        }, 0);
                    }
                    break;
                }
            }
        }

        function handleTouchEnd(e) {
            const wasQuickTap = touchTimeout !== null; // Timer still running = quick tap
            const listId = touchDragListId;
            const taskId = touchDragTaskId;

            // Clear the long-press timer
            if (touchTimeout) {
                clearTimeout(touchTimeout);
                touchTimeout = null;
            }

            if (isDragging && taskId) {
                // Was dragging - finish drag
                const element = document.querySelector(`.task-item[data-task-id="${taskId}"][data-list-id="${listId}"]`);
                if (element) {
                    element.classList.remove('bg-blue-100', 'shadow-lg', 'z-50', 'border-l-4', 'border-blue-500');
                }
                document.removeEventListener('touchmove', handleTouchMove);
                saveState();
            } else if (wasQuickTap && taskId && listId) {
                // Quick tap - open edit
                editTask(listId, taskId);
            }

            touchDragElement = null;
            touchDragListId = null;
            touchDragTaskId = null;
            isDragging = false;
        }

        function reorderTasks(listId, fromTaskId, toTaskId) {
            if (fromTaskId === toTaskId) return;

            const taskList = state.taskLists.find(l => l.id === listId);
            const fromIndex = taskList.tasks.findIndex(t => t.id === fromTaskId);
            const toIndex = taskList.tasks.findIndex(t => t.id === toTaskId);

            if (fromIndex !== -1 && toIndex !== -1 && fromIndex !== toIndex) {
                const [removed] = taskList.tasks.splice(fromIndex, 1);
                taskList.tasks.splice(toIndex, 0, removed);
                renderTaskLists();
            }
        }

        function resetAllTasks(listId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            if (taskList) {
                taskList.tasks.forEach(t => t.done = false);
                saveState();
                renderTaskLists();
            }
        }

        function getTaskListProgress(taskList) {
            if (taskList.tasks.length === 0) return { completed: 0, total: 0, percent: 0 };
            const completed = taskList.tasks.filter(t => t.done).length;
            return {
                completed,
                total: taskList.tasks.length,
                percent: Math.round((completed / taskList.tasks.length) * 100)
            };
        }

        // Order Generation
        function generateOrder() {
            const itemsToOrder = [];
            state.categories.forEach(category => {
                const needOrder = category.products.filter(p => p.quantity > 0);
                if (needOrder.length > 0) {
                    itemsToOrder.push({
                        category: category.name,
                        items: needOrder.map(p => ({
                            name: p.name,
                            quantity: p.quantity,
                            unit: p.unit || 'item'
                        }))
                    });
                }
            });

            if (itemsToOrder.length === 0) {
                alert('No items to order! All inventory is OK.');
                return;
            }

            let orderText = `ORDER LIST\n${new Date().toLocaleDateString()}\n${'─'.repeat(20)}\n\n`;
            itemsToOrder.forEach(group => {
                orderText += `${group.category.toUpperCase()}\n`;
                group.items.forEach(item => {
                    const unitLabel = item.unit === 'package' ? 'pkg' : 'item';
                    orderText += `  - ${item.name} x${item.quantity} (${unitLabel})\n`;
                });
                orderText += '\n';
            });

            document.getElementById('order-text').textContent = orderText;
            document.getElementById('order-modal').classList.remove('hidden');
        }

        function generateCategoryOrder(categoryId) {
            const category = state.categories.find(c => c.id === categoryId);
            if (!category) return;

            const needOrder = category.products.filter(p => p.quantity > 0);
            if (needOrder.length === 0) {
                alert(`No items to order from ${category.name}!`);
                return;
            }

            let orderText = `ORDER LIST - ${category.name.toUpperCase()}\n${new Date().toLocaleDateString()}\n${'─'.repeat(20)}\n\n`;
            needOrder.forEach(item => {
                const unitLabel = (item.unit || 'item') === 'package' ? 'pkg' : 'item';
                orderText += `  - ${item.name} x${item.quantity} (${unitLabel})\n`;
            });

            document.getElementById('order-text').textContent = orderText;
            document.getElementById('order-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('order-modal').classList.add('hidden');
        }

        function copyOrder() {
            const text = document.getElementById('order-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Order list copied to clipboard!');
            });
        }

        function shareViaWhatsApp() {
            const text = encodeURIComponent(document.getElementById('order-text').textContent);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function shareViaEmail() {
            const text = encodeURIComponent(document.getElementById('order-text').textContent);
            const subject = encodeURIComponent(`Order List - ${new Date().toLocaleDateString()}`);
            window.open(`mailto:?subject=${subject}&body=${text}`, '_blank');
        }

        // Task Sharing
        function shareTaskList(listId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            if (!taskList || taskList.tasks.length === 0) {
                alert('No tasks to share in this list!');
                return;
            }

            const progress = getTaskListProgress(taskList);
            let taskText = `${taskList.name.toUpperCase()}\n${new Date().toLocaleDateString()}\n${'─'.repeat(20)}\n\n`;
            taskList.tasks.forEach(task => {
                const status = task.done ? '[x]' : '[ ]';
                taskText += `${status} ${task.text}\n`;
            });

            taskText += `\n${'─'.repeat(20)}\nProgress: ${progress.completed}/${progress.total} completed (${progress.percent}%)`;

            document.getElementById('share-text').textContent = taskText;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function shareAllTasks() {
            if (state.taskLists.length === 0) {
                alert('No task lists to share!');
                return;
            }

            // Show selection modal with checkboxes for each task list
            const container = document.getElementById('task-list-checkboxes');
            container.innerHTML = state.taskLists.map(taskList => {
                const progress = getTaskListProgress(taskList);
                return `
                    <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="share-list-${taskList.id}" value="${taskList.id}" checked
                               class="w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                        <div class="flex-1">
                            <div class="font-medium">${taskList.name}</div>
                            <div class="text-sm text-gray-500">${progress.total} tasks (${progress.completed} done)</div>
                        </div>
                    </label>
                `;
            }).join('');

            document.getElementById('select-tasks-modal').classList.remove('hidden');
        }

        function closeSelectModal() {
            document.getElementById('select-tasks-modal').classList.add('hidden');
        }

        function shareSelectedTasks() {
            // Get selected task list IDs
            const checkboxes = document.querySelectorAll('#task-list-checkboxes input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedIds.length === 0) {
                alert('Please select at least one task list to share!');
                return;
            }

            const selectedLists = state.taskLists.filter(l => selectedIds.includes(l.id));

            let taskText = `DAILY TASKS\n${new Date().toLocaleDateString()}\n${'═'.repeat(25)}\n`;

            selectedLists.forEach(taskList => {
                const progress = getTaskListProgress(taskList);
                taskText += `\n${taskList.name.toUpperCase()}\n${'─'.repeat(20)}\n`;
                if (taskList.tasks.length === 0) {
                    taskText += `  (No tasks)\n`;
                } else {
                    taskList.tasks.forEach(task => {
                        const status = task.done ? '[x]' : '[ ]';
                        taskText += `${status} ${task.text}\n`;
                    });
                    taskText += `Progress: ${progress.completed}/${progress.total} (${progress.percent}%)\n`;
                }
            });

            closeSelectModal();
            document.getElementById('share-text').textContent = taskText;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
        }

        function copyTaskList() {
            const text = document.getElementById('share-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Task list copied to clipboard!');
            });
        }

        function shareTasksWhatsApp() {
            const text = encodeURIComponent(document.getElementById('share-text').textContent);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function shareTasksEmail() {
            const text = encodeURIComponent(document.getElementById('share-text').textContent);
            const subject = encodeURIComponent(`Daily Tasks - ${new Date().toLocaleDateString()}`);
            window.open(`mailto:?subject=${subject}&body=${text}`, '_blank');
        }

        // Render Functions
        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = state.categories.map(category => {
                const isExpanded = expandedCategories.includes(category.id);
                const itemsNeedingOrder = category.products.filter(p => p.quantity > 0).length;
                return `
                <div class="bg-white rounded-lg shadow mb-3" style="max-width: 100%; overflow: hidden;">
                    <div class="bg-gray-800 text-white px-2 py-2 flex justify-between items-center cursor-pointer" onclick="toggleCategory(${category.id})">
                        <div class="flex items-center gap-1">
                            <span class="transition-transform ${isExpanded ? 'rotate-90' : ''}">&gt;</span>
                            <h3 class="font-bold text-sm">${category.name}</h3>
                            ${itemsNeedingOrder > 0 ? `<span class="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full">${itemsNeedingOrder}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                            <button onclick="resetCategory(${category.id})" class="text-green-300 hover:text-green-100 text-xs">
                                Reset
                            </button>
                            <button onclick="generateCategoryOrder(${category.id})" class="text-amber-300 hover:text-amber-100 text-xs">
                                Order
                            </button>
                            <button onclick="deleteCategory(${category.id})" class="text-red-300 hover:text-red-100 text-xs">
                                Del
                            </button>
                        </div>
                    </div>
                    <div class="${isExpanded ? '' : 'hidden'} p-2" style="max-width: 100%; overflow: hidden;">
                        <div class="flex gap-1 mb-2" style="max-width: 100%;">
                            <input type="text" id="product-input-${category.id}" placeholder="Add product..."
                                   class="flex-1 min-w-0 px-2 py-2 border rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                                   onkeypress="if(event.key==='Enter')addProduct(${category.id})">
                            <button onclick="addProduct(${category.id})" class="bg-gray-200 px-3 py-2 rounded-lg text-sm hover:bg-gray-300 flex-shrink-0">
                                +
                            </button>
                        </div>
                        <div class="divide-y">
                            ${category.products.map(product => {
                                const status = getStockStatus(product.quantity);
                                const needsOrder = product.quantity > 0;
                                const unit = product.unit || 'item';
                                const unitLabel = unit === 'package' ? 'pkg' : 'item';
                                return `
                                <div class="product-row flex items-center justify-between py-2 gap-2">
                                    <span class="product-name ${needsOrder ? 'text-red-500 font-medium' : ''}">${product.name}</span>
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleProductUnit(${category.id}, ${product.id})"
                                                class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200">
                                            ${unitLabel}
                                        </button>
                                        <div class="flex items-center">
                                            <button ontouchstart="handleQtyTouchStart(event, ${category.id}, ${product.id}, false)"
                                                    ontouchend="handleQtyTouchEnd(event, ${category.id}, ${product.id}, false)"
                                                    onclick="return false"
                                                    class="qty-btn w-8 h-8 rounded-l-lg bg-gray-200 hover:bg-gray-300 font-bold text-lg">
                                                -
                                            </button>
                                            <span class="w-10 h-8 flex items-center justify-center bg-gray-100 font-medium text-sm">
                                                ${product.quantity}
                                            </span>
                                            <button ontouchstart="handleQtyTouchStart(event, ${category.id}, ${product.id}, true)"
                                                    ontouchend="handleQtyTouchEnd(event, ${category.id}, ${product.id}, true)"
                                                    onclick="return false"
                                                    class="qty-btn w-8 h-8 rounded-r-lg bg-gray-200 hover:bg-gray-300 font-bold text-lg">
                                                +
                                            </button>
                                        </div>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${status.color}">
                                            ${status.label}
                                        </span>
                                        <button onclick="deleteProduct(${category.id}, ${product.id})"
                                                class="text-gray-400 hover:text-red-500 text-lg">
                                            &times;
                                        </button>
                                    </div>
                                </div>
                            `}).join('')}
                            ${category.products.length === 0 ? '<p class="text-gray-400 text-sm py-2">No products yet</p>' : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function renderTaskLists() {
            const container = document.getElementById('task-lists-container');
            if (state.taskLists.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 bg-white rounded-lg shadow">No task lists yet. Create your first one above!</p>';
                return;
            }

            container.innerHTML = state.taskLists.map(taskList => {
                const progress = getTaskListProgress(taskList);
                const isExpanded = expandedTaskLists.includes(taskList.id);
                const color = taskListColors[taskList.color] || taskListColors.blue;
                const colorPickerHtml = Object.keys(taskListColors).map(c =>
                    `<button onclick="changeTaskListColor(${taskList.id}, '${c}')"
                             class="w-5 h-5 rounded-full ${taskListColors[c].bg} ${taskList.color === c ? 'ring-2 ring-white ring-offset-1' : 'opacity-70 hover:opacity-100'}"
                             title="${c}"></button>`
                ).join('');
                return `
                <div class="bg-white rounded-lg shadow mb-4 overflow-hidden">
                    <div class="${color.bg} text-white px-4 py-3 cursor-pointer" onclick="toggleTaskList(${taskList.id})">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="transition-transform ${isExpanded ? 'rotate-90' : ''}">&gt;</span>
                                <h3 class="font-bold">${taskList.name}</h3>
                            </div>
                            <div class="flex items-center gap-3" onclick="event.stopPropagation()">
                                <span class="${color.text} text-sm">${progress.completed}/${progress.total}</span>
                                <button onclick="deleteTaskList(${taskList.id})" class="text-red-300 hover:text-red-100 text-sm">
                                    Delete
                                </button>
                            </div>
                        </div>
                        ${progress.total > 0 ? `
                        <div class="mt-2 ${color.progress} rounded-full h-2">
                            <div class="bg-white rounded-full h-2 transition-all" style="width: ${progress.percent}%"></div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="${isExpanded ? '' : 'hidden'} p-3">
                        <!-- Color Picker -->
                        <div class="flex items-center gap-2 mb-3 pb-3 border-b">
                            <span class="text-xs text-gray-500">Color:</span>
                            <div class="flex gap-1">${colorPickerHtml}</div>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="task-input-${taskList.id}" placeholder="Add task..."
                                   class="flex-1 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeypress="if(event.key==='Enter')addTask(${taskList.id})">
                            <button onclick="addTask(${taskList.id})" class="bg-gray-200 px-3 py-2 rounded-lg text-sm hover:bg-gray-300">
                                +
                            </button>
                        </div>
                        <div class="divide-y task-list-container" data-list-id="${taskList.id}">
                            ${taskList.tasks.map((task, index) => `
                                <div class="task-item flex items-center gap-3 py-3 ${task.done ? 'opacity-60' : ''}"
                                     dir="rtl"
                                     data-task-id="${task.id}"
                                     data-list-id="${taskList.id}">
                                    <input type="checkbox" ${task.done ? 'checked' : ''}
                                           onchange="toggleTask(${taskList.id}, ${task.id})"
                                           class="task-checkbox w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500 cursor-pointer">
                                    <span class="task-text flex-1 text-right ${task.done ? 'line-through text-gray-400' : ''}">${task.text}</span>
                                    <button onclick="deleteTask(${taskList.id}, ${task.id})" class="task-delete text-gray-400 hover:text-red-500 text-lg px-2">
                                        &times;
                                    </button>
                                </div>
                            `).join('')}
                            ${taskList.tasks.length === 0 ? '<p class="text-gray-400 text-sm py-2">No tasks yet</p>' : ''}
                        </div>
                        ${taskList.tasks.length > 0 ? `
                        <div class="flex gap-2 mt-3 pt-3 border-t">
                            <button onclick="resetAllTasks(${taskList.id})" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg text-sm hover:bg-gray-200">
                                Reset All
                            </button>
                            <button onclick="shareTaskList(${taskList.id})" class="flex-1 bg-emerald-100 text-emerald-700 py-2 rounded-lg text-sm hover:bg-emerald-200">
                                Share
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        function renderAll() {
            renderCategories();
            renderTaskLists();
        }

        // Handle Enter key for inputs
        document.getElementById('new-category').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addCategory();
        });

        document.getElementById('new-task-list').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTaskList();
        });

        // Close modals on backdrop click
        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target.id === 'order-modal') closeModal();
        });

        document.getElementById('select-tasks-modal').addEventListener('click', (e) => {
            if (e.target.id === 'select-tasks-modal') closeSelectModal();
        });

        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.id === 'share-modal') closeShareModal();
        });

        // Initialize
        updateLocationUI();
        loadState();
        initTouchDrag();
    </script>
</body>
</html>
