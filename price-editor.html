<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>עריכת מחירים - Zucca Café</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="api-client.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f3f4f6;
        }
        .price-input:focus {
            outline: none;
            ring: 2px;
            ring-color: #6366f1;
        }
        .save-indicator {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-4xl mx-auto p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex items-center justify-between flex-wrap gap-4" dir="rtl">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-gray-800">עריכת מחירים</h1>
                    <a href="index.html" class="text-indigo-600 hover:text-indigo-800 text-sm">← חזרה לניהול</a>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500">סניף:</span>
                    <select id="locationSelect" onchange="switchLocation(this.value)"
                            class="px-3 py-1.5 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="isgav">יסגב</option>
                        <option value="frankfurt">פרנקפורט</option>
                    </select>
                    <span id="saveIndicator" class="save-indicator text-green-600 text-sm">✓ נשמר</span>
                </div>
            </div>
        </div>

        <!-- Price Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div id="priceTable" class="divide-y divide-gray-200">
                <!-- Content rendered by JS -->
            </div>
            <div id="emptyState" class="hidden p-8 text-center text-gray-500" dir="rtl">
                אין מוצרים להצגה
            </div>
            <div id="loadingState" class="p-8 text-center text-gray-500" dir="rtl">
                טוען...
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://98mctlbso0.execute-api.eu-central-1.amazonaws.com/prod';

        // Initialize API client
        const api = new BusinessManagerAPI({ baseUrl: API_BASE_URL });

        // State
        let currentLocation = 'isgav';
        let state = { categories: [], taskLists: [] };
        let unsubscribe = null;
        let saveTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check URL params for location
            const params = new URLSearchParams(window.location.search);
            const loc = params.get('location');
            if (loc && (loc === 'isgav' || loc === 'frankfurt')) {
                currentLocation = loc;
                document.getElementById('locationSelect').value = loc;
            }

            subscribeToLocation();
        });

        function switchLocation(locationId) {
            currentLocation = locationId;

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('location', locationId);
            window.history.replaceState({}, '', url);

            // Resubscribe to new location
            subscribeToLocation();
        }

        function subscribeToLocation() {
            // Cleanup previous subscription
            if (unsubscribe) {
                unsubscribe();
            }

            // Show loading
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('priceTable').innerHTML = '';
            document.getElementById('emptyState').classList.add('hidden');

            // Subscribe to location updates
            unsubscribe = api.subscribeLocation(currentLocation, (data) => {
                state.categories = data.categories || [];
                state.taskLists = data.taskLists || [];
                renderPriceTable();
            });
        }

        function renderPriceTable() {
            const container = document.getElementById('priceTable');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');

            loadingState.classList.add('hidden');

            if (!state.categories || state.categories.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Build table HTML
            let html = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr dir="rtl">
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">קטגוריה</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מוצר</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">מחיר (₪)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            state.categories.forEach(category => {
                if (!category.products || category.products.length === 0) return;

                category.products.forEach((product, idx) => {
                    const price = product.price || '';
                    const isFirst = idx === 0;
                    const rowspan = category.products.length;

                    html += `
                        <tr class="hover:bg-gray-50" dir="rtl">
                            ${isFirst ? `<td class="px-4 py-3 text-sm font-medium text-gray-900 align-top border-l" rowspan="${rowspan}">${category.name}</td>` : ''}
                            <td class="px-4 py-3 text-sm text-gray-700">${product.name}</td>
                            <td class="px-4 py-3 text-center">
                                <input type="number"
                                       value="${price}"
                                       min="0"
                                       step="0.5"
                                       data-category="${category.id}"
                                       data-product="${product.id}"
                                       onchange="updatePrice(${category.id}, ${product.id}, this.value)"
                                       class="w-20 px-2 py-1 border border-gray-300 rounded text-center text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                       placeholder="0">
                            </td>
                        </tr>
                    `;
                });
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        async function updatePrice(categoryId, productId, value) {
            const price = parseFloat(value) || 0;

            // Update local state
            const category = state.categories.find(c => c.id === categoryId);
            if (category) {
                const product = category.products.find(p => p.id === productId);
                if (product) {
                    product.price = price;
                }
            }

            // Debounce save
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }

            saveTimeout = setTimeout(async () => {
                try {
                    await api.saveLocation(currentLocation, {
                        categories: state.categories,
                        taskLists: state.taskLists
                    });
                    showSaveIndicator();
                } catch (err) {
                    console.error('Failed to save:', err);
                    alert('שגיאה בשמירה. נסה שוב.');
                }
            }, 500);
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>
