<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Zucca Café - Staff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        .tab-active { border-bottom: 3px solid #3B82F6; color: #3B82F6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-lg mx-auto px-4 py-3">
            <h1 id="location-name" class="text-xl font-bold text-gray-800 text-center">Zucca Café</h1>
            <p class="text-xs text-gray-400 text-center">Staff View</p>
            <!-- Location Switcher -->
            <div class="flex justify-center gap-2 mt-2">
                <button class="location-btn px-3 py-1 rounded-full text-sm font-medium bg-blue-600 text-white"
                        data-location="isgav" onclick="switchLocation('isgav')">
                    Isgav
                </button>
                <button class="location-btn px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-700"
                        data-location="frankfurt" onclick="switchLocation('frankfurt')">
                    Frankfurt
                </button>
            </div>
        </div>
        <!-- Tabs -->
        <div class="max-w-lg mx-auto flex border-b">
            <button id="tab-inventory" class="flex-1 py-3 text-center font-medium tab-active" onclick="switchTab('inventory')">
                Inventory
            </button>
            <button id="tab-tasks" class="flex-1 py-3 text-center font-medium text-gray-500" onclick="switchTab('tasks')">
                Daily Tasks
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-lg mx-auto pb-24">
        <!-- Inventory Tab -->
        <div id="inventory-tab" class="p-4">
            <!-- Categories Container -->
            <div id="categories-container"></div>

            <!-- Share Inventory Button -->
            <div class="mt-4">
                <button onclick="shareInventory()" class="w-full bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">
                    Share Inventory
                </button>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks-tab" class="p-4 hidden">
            <!-- Task Lists Container -->
            <div id="task-lists-container"></div>

            <!-- Task Actions -->
            <div class="mt-4">
                <button onclick="shareAllTasks()" class="w-full bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">
                    Share Tasks
                </button>
            </div>
        </div>
    </main>

    <!-- Select Tasks Modal -->
    <div id="select-tasks-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Select Lists to Share</h2>
                <button onclick="closeSelectModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div id="task-list-checkboxes" class="space-y-3"></div>
            </div>
            <div class="p-4 border-t flex gap-2">
                <button onclick="closeSelectModal()" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium hover:bg-gray-300">
                    Cancel
                </button>
                <button onclick="shareSelectedTasks()" class="flex-1 bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">
                    Share Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Share Task List</h2>
                <button onclick="closeShareModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <pre id="share-text" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap"></pre>
            </div>
            <div class="p-4 border-t flex gap-2">
                <button onclick="copyTaskList()" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium hover:bg-gray-300">
                    Copy
                </button>
                <button onclick="shareTasksWhatsApp()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600">
                    WhatsApp
                </button>
                <button onclick="shareTasksEmail()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600">
                    Email
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBG8XLW_A0mah5B6E-1EPf9DvA96ym6Xgg",
            authDomain: "zucca-mang.firebaseapp.com",
            projectId: "zucca-mang",
            storageBucket: "zucca-mang.firebasestorage.app",
            messagingSenderId: "423632065920",
            appId: "1:423632065920:web:43c340defd3fe33442dd65"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Location Configuration
        const locations = [
            { id: 'isgav', name: 'Zucca Isgav' },
            { id: 'frankfurt', name: 'Zucca Frankfurt' }
        ];
        let currentLocation = localStorage.getItem('currentLocation') || 'isgav';
        let unsubscribe = null;

        // Data State
        let state = {
            categories: [],
            taskLists: []
        };

        // UI State (not saved to Firebase)
        let expandedCategories = [];
        let expandedTaskLists = [];

        // Color Options for Task Lists (read-only in employee view)
        const taskListColors = {
            blue: { bg: 'bg-blue-600', progress: 'bg-blue-800', text: 'text-blue-200' },
            green: { bg: 'bg-green-600', progress: 'bg-green-800', text: 'text-green-200' },
            red: { bg: 'bg-red-600', progress: 'bg-red-800', text: 'text-red-200' },
            orange: { bg: 'bg-orange-500', progress: 'bg-orange-700', text: 'text-orange-200' },
            purple: { bg: 'bg-purple-600', progress: 'bg-purple-800', text: 'text-purple-200' },
            pink: { bg: 'bg-pink-500', progress: 'bg-pink-700', text: 'text-pink-200' },
            teal: { bg: 'bg-teal-600', progress: 'bg-teal-800', text: 'text-teal-200' },
            gray: { bg: 'bg-gray-600', progress: 'bg-gray-800', text: 'text-gray-300' }
        };

        // Switch Location
        function switchLocation(locationId) {
            if (unsubscribe) unsubscribe();
            currentLocation = locationId;
            localStorage.setItem('currentLocation', locationId);
            expandedCategories = [];
            expandedTaskLists = [];
            updateLocationUI();
            loadState();
        }

        function updateLocationUI() {
            const locationName = locations.find(l => l.id === currentLocation)?.name || 'Zucca';
            document.getElementById('location-name').textContent = locationName;
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.toggle('bg-blue-600', btn.dataset.location === currentLocation);
                btn.classList.toggle('text-white', btn.dataset.location === currentLocation);
                btn.classList.toggle('bg-gray-200', btn.dataset.location !== currentLocation);
                btn.classList.toggle('text-gray-700', btn.dataset.location !== currentLocation);
            });
        }

        // Load from Firestore and listen for real-time updates
        function loadState() {
            unsubscribe = db.collection('locations').doc(currentLocation).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    state.categories = data.categories || [];
                    state.taskLists = data.taskLists || [];
                } else {
                    // No data yet - show empty state
                    state.categories = [];
                    state.taskLists = [];
                }
                renderAll();
            }, (error) => {
                console.error("Error loading data:", error);
                renderAll();
            });
        }

        // Save to Firestore
        function saveState() {
            db.collection('locations').doc(currentLocation).set({
                categories: state.categories,
                taskLists: state.taskLists
            }).catch((error) => {
                console.error("Error saving data:", error);
                alert("Error saving. Please check your connection.");
            });
        }

        // Tab Switching
        function switchTab(tab) {
            const inventoryTab = document.getElementById('inventory-tab');
            const tasksTab = document.getElementById('tasks-tab');
            const tabInventory = document.getElementById('tab-inventory');
            const tabTasks = document.getElementById('tab-tasks');

            if (tab === 'inventory') {
                inventoryTab.classList.remove('hidden');
                tasksTab.classList.add('hidden');
                tabInventory.classList.add('tab-active');
                tabInventory.classList.remove('text-gray-500');
                tabTasks.classList.remove('tab-active');
                tabTasks.classList.add('text-gray-500');
            } else {
                tasksTab.classList.remove('hidden');
                inventoryTab.classList.add('hidden');
                tabTasks.classList.add('tab-active');
                tabTasks.classList.remove('text-gray-500');
                tabInventory.classList.remove('tab-active');
                tabInventory.classList.add('text-gray-500');
            }
        }

        // Category Toggle
        function toggleCategory(categoryId) {
            const index = expandedCategories.indexOf(categoryId);
            if (index === -1) {
                expandedCategories.push(categoryId);
            } else {
                expandedCategories.splice(index, 1);
            }
            renderCategories();
        }

        // Stock Status Helper
        function getStockStatus(quantity) {
            if (quantity === 0) return { label: 'OK', color: 'bg-green-100 text-green-700' };
            return { label: 'Need ' + quantity, color: 'bg-red-100 text-red-700' };
        }

        // Quantity Functions (employees can adjust quantity)
        function incrementQuantity(categoryId, productId) {
            const category = state.categories.find(c => c.id == categoryId);
            if (!category) return;
            const product = category.products.find(p => p.id == productId);
            if (!product) return;
            product.quantity++;
            saveState();
            renderCategories();
        }

        function decrementQuantity(categoryId, productId) {
            const category = state.categories.find(c => c.id == categoryId);
            if (!category) return;
            const product = category.products.find(p => p.id == productId);
            if (!product) return;
            if (product.quantity > 0) {
                product.quantity--;
            }
            saveState();
            renderCategories();
        }

        function resetCategory(categoryId) {
            const category = state.categories.find(c => c.id == categoryId);
            if (!category) return;
            category.products.forEach(p => p.quantity = 0);
            saveState();
            renderCategories();
        }

        function toggleProductUnit(categoryId, productId) {
            const category = state.categories.find(c => c.id == categoryId);
            if (!category) return;
            const product = category.products.find(p => p.id == productId);
            if (product) {
                product.unit = product.unit === 'item' ? 'package' : 'item';
                saveState();
                renderCategories();
            }
        }

        // Task List Toggle
        function toggleTaskList(listId) {
            const index = expandedTaskLists.indexOf(listId);
            if (index === -1) {
                expandedTaskLists.push(listId);
            } else {
                expandedTaskLists.splice(index, 1);
            }
            renderTaskLists();
        }

        // Task Functions (only toggle allowed)
        function toggleTask(listId, taskId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            const task = taskList.tasks.find(t => t.id === taskId);
            task.done = !task.done;
            saveState();
            renderTaskLists();
        }

        function resetAllTasks(listId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            if (taskList) {
                taskList.tasks.forEach(t => t.done = false);
                saveState();
                renderTaskLists();
            }
        }

        function getTaskListProgress(taskList) {
            if (taskList.tasks.length === 0) return { completed: 0, total: 0, percent: 0 };
            const completed = taskList.tasks.filter(t => t.done).length;
            return {
                completed,
                total: taskList.tasks.length,
                percent: Math.round((completed / taskList.tasks.length) * 100)
            };
        }

        // Inventory Sharing
        function shareInventory() {
            if (state.categories.length === 0) {
                alert('No inventory to share!');
                return;
            }

            let inventoryText = `INVENTORY STATUS\n${new Date().toLocaleDateString()}\n${'═'.repeat(25)}\n`;

            state.categories.forEach(category => {
                inventoryText += `\n${category.name.toUpperCase()}\n${'─'.repeat(20)}\n`;
                if (category.products.length === 0) {
                    inventoryText += `  (No products)\n`;
                } else {
                    category.products.forEach(product => {
                        const status = getStockStatus(product.quantity);
                        const unitLabel = (product.unit || 'item') === 'package' ? 'pkg' : 'item';
                        inventoryText += `${product.name}: ${product.quantity} ${unitLabel} (${status.label})\n`;
                    });
                }
            });

            // Add summary of items that need ordering
            const orderItems = [];
            state.categories.forEach(category => {
                category.products.forEach(product => {
                    if (product.quantity > 0) {
                        const unitLabel = (product.unit || 'item') === 'package' ? 'pkg' : 'item';
                        orderItems.push(`${product.name} x${product.quantity} (${unitLabel})`);
                    }
                });
            });

            if (orderItems.length > 0) {
                inventoryText += `\n${'═'.repeat(25)}\nNEEDS ORDERING:\n`;
                orderItems.forEach(item => {
                    inventoryText += `- ${item}\n`;
                });
            }

            document.getElementById('share-text').textContent = inventoryText;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        // Task Sharing
        function shareTaskList(listId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            if (!taskList || taskList.tasks.length === 0) {
                alert('No tasks to share in this list!');
                return;
            }

            const progress = getTaskListProgress(taskList);
            let taskText = `${taskList.name.toUpperCase()}\n${new Date().toLocaleDateString()}\n${'─'.repeat(20)}\n\n`;
            taskList.tasks.forEach(task => {
                const status = task.done ? '[x]' : '[ ]';
                taskText += `${status} ${task.text}\n`;
            });

            taskText += `\n${'─'.repeat(20)}\nProgress: ${progress.completed}/${progress.total} completed (${progress.percent}%)`;

            document.getElementById('share-text').textContent = taskText;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function shareAllTasks() {
            if (state.taskLists.length === 0) {
                alert('No task lists available!');
                return;
            }

            const container = document.getElementById('task-list-checkboxes');
            container.innerHTML = state.taskLists.map(taskList => {
                const progress = getTaskListProgress(taskList);
                return `
                    <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="share-list-${taskList.id}" value="${taskList.id}" checked
                               class="w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                        <div class="flex-1">
                            <div class="font-medium">${taskList.name}</div>
                            <div class="text-sm text-gray-500">${progress.total} tasks (${progress.completed} done)</div>
                        </div>
                    </label>
                `;
            }).join('');

            document.getElementById('select-tasks-modal').classList.remove('hidden');
        }

        function closeSelectModal() {
            document.getElementById('select-tasks-modal').classList.add('hidden');
        }

        function shareSelectedTasks() {
            const checkboxes = document.querySelectorAll('#task-list-checkboxes input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedIds.length === 0) {
                alert('Please select at least one task list to share!');
                return;
            }

            const selectedLists = state.taskLists.filter(l => selectedIds.includes(l.id));

            let taskText = `DAILY TASKS\n${new Date().toLocaleDateString()}\n${'═'.repeat(25)}\n`;

            selectedLists.forEach(taskList => {
                const progress = getTaskListProgress(taskList);
                taskText += `\n${taskList.name.toUpperCase()}\n${'─'.repeat(20)}\n`;
                if (taskList.tasks.length === 0) {
                    taskText += `  (No tasks)\n`;
                } else {
                    taskList.tasks.forEach(task => {
                        const status = task.done ? '[x]' : '[ ]';
                        taskText += `${status} ${task.text}\n`;
                    });
                    taskText += `Progress: ${progress.completed}/${progress.total} (${progress.percent}%)\n`;
                }
            });

            closeSelectModal();
            document.getElementById('share-text').textContent = taskText;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
        }

        function copyTaskList() {
            const text = document.getElementById('share-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Task list copied to clipboard!');
            });
        }

        function shareTasksWhatsApp() {
            const text = encodeURIComponent(document.getElementById('share-text').textContent);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function shareTasksEmail() {
            const text = encodeURIComponent(document.getElementById('share-text').textContent);
            const subject = encodeURIComponent(`Daily Tasks - ${new Date().toLocaleDateString()}`);
            window.open(`mailto:?subject=${subject}&body=${text}`, '_blank');
        }

        // Render Functions (View Only - no edit controls)
        function renderCategories() {
            const container = document.getElementById('categories-container');

            if (state.categories.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 bg-white rounded-lg shadow">No inventory items yet.</p>';
                return;
            }

            container.innerHTML = state.categories.map(category => {
                const isExpanded = expandedCategories.includes(category.id);
                const itemsNeedingOrder = category.products.filter(p => p.quantity > 0).length;
                return `
                <div class="bg-white rounded-lg shadow mb-4 overflow-hidden">
                    <div class="bg-gray-800 text-white px-4 py-3 flex justify-between items-center cursor-pointer" onclick="toggleCategory(${category.id})">
                        <div class="flex items-center gap-2">
                            <span class="transition-transform ${isExpanded ? 'rotate-90' : ''}">&gt;</span>
                            <h3 class="font-bold">${category.name}</h3>
                            ${itemsNeedingOrder > 0 ? `<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">${itemsNeedingOrder}</span>` : ''}
                        </div>
                        <button onclick="event.stopPropagation(); resetCategory(${category.id})" class="text-green-300 hover:text-green-100 text-sm">
                            Reset All
                        </button>
                    </div>
                    <div class="${isExpanded ? '' : 'hidden'} p-3">
                        <div class="divide-y">
                            ${category.products.map(product => {
                                const status = getStockStatus(product.quantity);
                                const needsOrder = product.quantity > 0;
                                const unit = product.unit || 'item';
                                const unitLabel = unit === 'package' ? 'pkg' : 'item';
                                return `
                                <div class="flex items-center justify-between py-2">
                                    <span class="${needsOrder ? 'text-red-500 font-medium' : ''}">${product.name}</span>
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleProductUnit(${category.id}, ${product.id})"
                                                class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200">
                                            ${unitLabel}
                                        </button>
                                        <div class="flex items-center">
                                            <button onclick="decrementQuantity(${category.id}, ${product.id})"
                                                    class="w-8 h-8 rounded-l-lg bg-gray-200 hover:bg-gray-300 font-bold text-lg">
                                                -
                                            </button>
                                            <span class="w-10 h-8 flex items-center justify-center bg-gray-100 font-medium text-sm">
                                                ${product.quantity}
                                            </span>
                                            <button onclick="incrementQuantity(${category.id}, ${product.id})"
                                                    class="w-8 h-8 rounded-r-lg bg-gray-200 hover:bg-gray-300 font-bold text-lg">
                                                +
                                            </button>
                                        </div>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${status.color}">
                                            ${status.label}
                                        </span>
                                    </div>
                                </div>
                            `}).join('')}
                            ${category.products.length === 0 ? '<p class="text-gray-400 text-sm py-2">No products</p>' : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function renderTaskLists() {
            const container = document.getElementById('task-lists-container');

            if (state.taskLists.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 bg-white rounded-lg shadow">No task lists available.</p>';
                return;
            }

            container.innerHTML = state.taskLists.map(taskList => {
                const progress = getTaskListProgress(taskList);
                const isExpanded = expandedTaskLists.includes(taskList.id);
                const color = taskListColors[taskList.color] || taskListColors.blue;
                return `
                <div class="bg-white rounded-lg shadow mb-4 overflow-hidden">
                    <div class="${color.bg} text-white px-4 py-3 cursor-pointer" onclick="toggleTaskList(${taskList.id})">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="transition-transform ${isExpanded ? 'rotate-90' : ''}">&gt;</span>
                                <h3 class="font-bold">${taskList.name}</h3>
                            </div>
                            <span class="${color.text} text-sm">${progress.completed}/${progress.total}</span>
                        </div>
                        ${progress.total > 0 ? `
                        <div class="mt-2 ${color.progress} rounded-full h-2">
                            <div class="bg-white rounded-full h-2 transition-all" style="width: ${progress.percent}%"></div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="${isExpanded ? '' : 'hidden'} p-3">
                        <div class="divide-y">
                            ${taskList.tasks.map(task => `
                                <div class="flex items-center gap-3 py-2 ${task.done ? 'opacity-60' : ''}">
                                    <input type="checkbox" ${task.done ? 'checked' : ''}
                                           onchange="toggleTask(${taskList.id}, ${task.id})"
                                           class="w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500 cursor-pointer">
                                    <span class="flex-1 ${task.done ? 'line-through text-gray-400' : ''}">${task.text}</span>
                                </div>
                            `).join('')}
                            ${taskList.tasks.length === 0 ? '<p class="text-gray-400 text-sm py-2">No tasks</p>' : ''}
                        </div>
                        ${taskList.tasks.length > 0 ? `
                        <div class="mt-3 pt-3 border-t flex gap-2">
                            <button onclick="resetAllTasks(${taskList.id})" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg text-sm hover:bg-gray-200">
                                Reset All
                            </button>
                            <button onclick="shareTaskList(${taskList.id})" class="flex-1 bg-emerald-100 text-emerald-700 py-2 rounded-lg text-sm hover:bg-emerald-200">
                                Share This List
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        function renderAll() {
            renderCategories();
            renderTaskLists();
        }

        // Close modals on backdrop click
        document.getElementById('select-tasks-modal').addEventListener('click', (e) => {
            if (e.target.id === 'select-tasks-modal') closeSelectModal();
        });

        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.id === 'share-modal') closeShareModal();
        });

        // Initialize
        updateLocationUI();
        loadState();
    </script>
</body>
</html>
