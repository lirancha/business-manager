<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Zucca Café - Staff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            max-width: 100vw;
        }
        html {
            overflow-x: hidden;
            width: 100vw;
        }
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
            position: relative;
        }
        #app-wrapper {
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
        }
        .tab-active { border-bottom: 3px solid #3B82F6; color: #3B82F6; }
        /* Schedule availability styles */
        .shift-btn { transition: all 0.2s; }
        .shift-btn.shift-available { background-color: #22c55e; color: white; }
        .shift-btn:not(.shift-available) { background-color: #e5e7eb; color: #6b7280; }
        .shift-btn.shift-partial { background-color: #f59e0b; color: white; }
        .avail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .avail-modal.show { display: flex; }
        .avail-modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 320px;
            width: 90%;
        }
        .product-name {
            flex: 1;
            min-width: 0;
        }
        .qty-btn {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        .flex {
            max-width: 100%;
        }
        input, button {
            max-width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
<div id="app-wrapper">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="px-4 py-3">
            <h1 id="location-name" class="text-xl font-bold text-gray-800 text-center">Zucca Café</h1>
            <p class="text-xs text-gray-400 text-center">Staff View</p>
            <!-- Location Switcher -->
            <div class="flex justify-center gap-2 mt-2">
                <button class="location-btn px-3 py-1 rounded-full text-sm font-medium bg-blue-600 text-white"
                        data-location="isgav" onclick="switchLocation('isgav')">
                    Isgav
                </button>
                <button class="location-btn px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-700"
                        data-location="frankfurt" onclick="switchLocation('frankfurt')">
                    Frankfurt
                </button>
            </div>
        </div>
        <!-- Tabs -->
        <div class="flex border-b">
            <button id="tab-inventory" class="flex-1 py-3 text-center font-medium tab-active" onclick="switchTab('inventory')">
                Inventory
            </button>
            <button id="tab-tasks" class="flex-1 py-3 text-center font-medium text-gray-500" onclick="switchTab('tasks')">
                Tasks
            </button>
            <button id="tab-schedule" class="flex-1 py-3 text-center font-medium text-gray-500" onclick="switchTab('schedule')">
                Schedule
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pb-24 px-2">
        <!-- Inventory Tab -->
        <div id="inventory-tab" class="py-2">
            <!-- Categories Container -->
            <div id="categories-container"></div>

            <!-- Share Inventory Button -->
            <div class="mt-4">
                <button onclick="shareInventory()" class="w-full bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">
                    Share Inventory
                </button>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks-tab" class="py-2 hidden">
            <!-- Task Lists Container -->
            <div id="task-lists-container"></div>

            <!-- Task Actions -->
            <div class="mt-4">
                <button onclick="shareAllTasks()" class="w-full bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">
                    Share Tasks
                </button>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule-tab" class="py-2 hidden">
            <!-- Employee Selection -->
            <div class="bg-white rounded-xl p-4 mb-4 shadow">
                <label class="block text-gray-700 font-medium mb-2">Select Your Name:</label>
                <select id="schedule-employee-select" onchange="scheduleLoadMyAvailability()" class="w-full p-3 border rounded-lg text-lg">
                    <option value="">-- Choose your name --</option>
                </select>
            </div>

            <!-- Week Navigation -->
            <div class="bg-white rounded-xl p-4 mb-4 shadow">
                <div class="flex justify-between items-center">
                    <button onclick="scheduleChangeWeek(-1)" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <div class="text-center">
                        <div id="schedule-week-label" class="font-bold text-gray-800">Week Schedule</div>
                        <div id="schedule-week-dates" class="text-sm text-gray-500"></div>
                    </div>
                    <button onclick="scheduleChangeWeek(1)" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Availability Grid -->
            <div id="schedule-availability-grid" class="space-y-3">
                <!-- Days will be rendered here -->
            </div>

            <!-- Submit Button -->
            <div class="mt-4">
                <button onclick="scheduleSubmitAvailability()" id="schedule-submit-btn" disabled
                        class="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-green-600 transition-colors">
                    Submit Availability
                </button>
            </div>

            <!-- View My Schedule Section -->
            <div class="mt-6 bg-white rounded-xl p-4 shadow">
                <h2 class="font-bold text-gray-800 mb-3">My Schedule This Week</h2>
                <div id="schedule-my-shifts" class="text-gray-500 text-sm">
                    Select your name to see your assigned shifts
                </div>
            </div>

            <!-- Status Message -->
            <div id="schedule-status-message" class="hidden mt-4 p-4 rounded-xl text-center font-medium"></div>
        </div>
    </main>

    <!-- Custom Hours Modal -->
    <div id="schedule-hours-modal" class="avail-modal">
        <div class="avail-modal-content">
            <h3 class="font-bold text-lg mb-4 text-center" id="schedule-modal-title">Set Hours</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-4">
                    <label class="w-16 text-gray-600">From:</label>
                    <input type="time" id="schedule-modal-start" class="flex-1 p-2 border rounded-lg text-lg">
                </div>
                <div class="flex items-center gap-4">
                    <label class="w-16 text-gray-600">To:</label>
                    <input type="time" id="schedule-modal-end" class="flex-1 p-2 border rounded-lg text-lg">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="schedule-modal-full-shift" class="w-5 h-5" checked>
                    <label for="schedule-modal-full-shift" class="text-gray-600">Full shift (use default hours)</label>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="scheduleCloseModal()" class="flex-1 py-2 px-4 bg-gray-200 rounded-lg font-medium">Cancel</button>
                <button onclick="scheduleSaveHours()" class="flex-1 py-2 px-4 bg-green-500 text-white rounded-lg font-medium">Save</button>
                <button onclick="scheduleRemoveAvailability()" class="py-2 px-4 bg-red-500 text-white rounded-lg font-medium">Remove</button>
            </div>
        </div>
    </div>

    <!-- Select Tasks Modal -->
    <div id="select-tasks-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Select Lists to Share</h2>
                <button onclick="closeSelectModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div id="task-list-checkboxes" class="space-y-3"></div>
            </div>
            <div class="p-4 border-t flex gap-2">
                <button onclick="closeSelectModal()" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium hover:bg-gray-300">
                    Cancel
                </button>
                <button onclick="shareSelectedTasks()" class="flex-1 bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">
                    Share Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Share Task List</h2>
                <button onclick="closeShareModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <pre id="share-text" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap"></pre>
            </div>
            <div class="p-4 border-t flex gap-2">
                <button onclick="copyTaskList()" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium hover:bg-gray-300">
                    Copy
                </button>
                <button onclick="shareTasksWhatsApp()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600">
                    WhatsApp
                </button>
                <button onclick="shareTasksEmail()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600">
                    Email
                </button>
            </div>
        </div>
    </div>
</div><!-- end app-wrapper -->

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBG8XLW_A0mah5B6E-1EPf9DvA96ym6Xgg",
            authDomain: "zucca-mang.firebaseapp.com",
            projectId: "zucca-mang",
            storageBucket: "zucca-mang.firebasestorage.app",
            messagingSenderId: "423632065920",
            appId: "1:423632065920:web:43c340defd3fe33442dd65"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Location Configuration
        const locations = [
            { id: 'isgav', name: 'Zucca Isgav' },
            { id: 'frankfurt', name: 'Zucca Frankfurt' }
        ];
        let currentLocation = localStorage.getItem('currentLocation') || 'isgav';
        let unsubscribe = null;

        // Data State
        let state = {
            categories: [],
            taskLists: []
        };

        // UI State (not saved to Firebase)
        let expandedCategories = [];
        let expandedTaskLists = [];

        // Color Options for Task Lists (read-only in employee view)
        const taskListColors = {
            blue: { bg: 'bg-blue-600', progress: 'bg-blue-800', text: 'text-blue-200' },
            green: { bg: 'bg-green-600', progress: 'bg-green-800', text: 'text-green-200' },
            red: { bg: 'bg-red-600', progress: 'bg-red-800', text: 'text-red-200' },
            orange: { bg: 'bg-orange-500', progress: 'bg-orange-700', text: 'text-orange-200' },
            purple: { bg: 'bg-purple-600', progress: 'bg-purple-800', text: 'text-purple-200' },
            pink: { bg: 'bg-pink-500', progress: 'bg-pink-700', text: 'text-pink-200' },
            teal: { bg: 'bg-teal-600', progress: 'bg-teal-800', text: 'text-teal-200' },
            gray: { bg: 'bg-gray-600', progress: 'bg-gray-800', text: 'text-gray-300' }
        };

        // Switch Location
        function switchLocation(locationId) {
            if (unsubscribe) unsubscribe();
            currentLocation = locationId;
            localStorage.setItem('currentLocation', locationId);
            expandedCategories = [];
            expandedTaskLists = [];
            updateLocationUI();
            loadState();
        }

        function updateLocationUI() {
            const locationName = locations.find(l => l.id === currentLocation)?.name || 'Zucca';
            document.getElementById('location-name').textContent = locationName;
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.toggle('bg-blue-600', btn.dataset.location === currentLocation);
                btn.classList.toggle('text-white', btn.dataset.location === currentLocation);
                btn.classList.toggle('bg-gray-200', btn.dataset.location !== currentLocation);
                btn.classList.toggle('text-gray-700', btn.dataset.location !== currentLocation);
            });
        }

        // Load from Firestore and listen for real-time updates
        function loadState() {
            unsubscribe = db.collection('locations').doc(currentLocation).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    state.categories = data.categories || [];
                    state.taskLists = data.taskLists || [];
                } else {
                    // No data yet - show empty state
                    state.categories = [];
                    state.taskLists = [];
                }
                renderAll();
            }, (error) => {
                console.error("Error loading data:", error);
                renderAll();
            });
        }

        // Save to Firestore
        function saveState() {
            db.collection('locations').doc(currentLocation).set({
                categories: state.categories,
                taskLists: state.taskLists
            }).catch((error) => {
                console.error("Error saving data:", error);
                alert("Error saving. Please check your connection.");
            });
        }

        // Tab Switching
        function switchTab(tab) {
            const inventoryTab = document.getElementById('inventory-tab');
            const tasksTab = document.getElementById('tasks-tab');
            const scheduleTab = document.getElementById('schedule-tab');
            const tabInventory = document.getElementById('tab-inventory');
            const tabTasks = document.getElementById('tab-tasks');
            const tabSchedule = document.getElementById('tab-schedule');

            // Hide all tabs
            inventoryTab.classList.add('hidden');
            tasksTab.classList.add('hidden');
            scheduleTab.classList.add('hidden');

            // Reset all tab buttons
            tabInventory.classList.remove('tab-active');
            tabInventory.classList.add('text-gray-500');
            tabTasks.classList.remove('tab-active');
            tabTasks.classList.add('text-gray-500');
            tabSchedule.classList.remove('tab-active');
            tabSchedule.classList.add('text-gray-500');

            // Show selected tab
            if (tab === 'inventory') {
                inventoryTab.classList.remove('hidden');
                tabInventory.classList.add('tab-active');
                tabInventory.classList.remove('text-gray-500');
            } else if (tab === 'tasks') {
                tasksTab.classList.remove('hidden');
                tabTasks.classList.add('tab-active');
                tabTasks.classList.remove('text-gray-500');
            } else if (tab === 'schedule') {
                scheduleTab.classList.remove('hidden');
                tabSchedule.classList.add('tab-active');
                tabSchedule.classList.remove('text-gray-500');
                // Initialize schedule data when tab is opened
                scheduleInit();
            }
        }

        // Category Toggle
        function toggleCategory(categoryId) {
            const index = expandedCategories.indexOf(categoryId);
            if (index === -1) {
                expandedCategories.push(categoryId);
            } else {
                expandedCategories.splice(index, 1);
            }
            renderCategories();
        }

        // Stock Status Helper
        function getStockStatus(quantity) {
            if (quantity === 0) return { label: 'OK', color: 'bg-green-100 text-green-700' };
            return { label: 'Need ' + quantity, color: 'bg-red-100 text-red-700' };
        }

        // Quantity Functions (employees can adjust quantity)
        function incrementQuantity(categoryId, productId, amount = 1) {
            const category = state.categories.find(c => c.id == categoryId);
            if (!category) return;
            const product = category.products.find(p => p.id == productId);
            if (!product) return;
            product.quantity += amount;
            saveState();
            renderCategories();
        }

        function decrementQuantity(categoryId, productId, amount = 1) {
            const category = state.categories.find(c => c.id == categoryId);
            if (!category) return;
            const product = category.products.find(p => p.id == productId);
            if (!product) return;
            product.quantity = Math.max(0, product.quantity - amount);
            saveState();
            renderCategories();
        }

        // Long press handlers for +/- buttons
        let qtyLongPressTimer = null;
        let qtyLongPressed = false;

        function handleQtyTouchStart(e, categoryId, productId, isIncrement) {
            qtyLongPressed = false;
            qtyLongPressTimer = setTimeout(() => {
                qtyLongPressed = true;
                navigator.vibrate && navigator.vibrate(50);
                if (isIncrement) {
                    incrementQuantity(categoryId, productId, 5);
                } else {
                    decrementQuantity(categoryId, productId, 5);
                }
            }, 500);
        }

        function handleQtyTouchEnd(e, categoryId, productId, isIncrement) {
            if (qtyLongPressTimer) {
                clearTimeout(qtyLongPressTimer);
                qtyLongPressTimer = null;
            }
            if (!qtyLongPressed) {
                if (isIncrement) {
                    incrementQuantity(categoryId, productId, 1);
                } else {
                    decrementQuantity(categoryId, productId, 1);
                }
            }
            qtyLongPressed = false;
        }

        function resetCategory(categoryId) {
            const category = state.categories.find(c => c.id == categoryId);
            if (!category) return;
            category.products.forEach(p => p.quantity = 0);
            saveState();
            renderCategories();
        }

        function toggleProductUnit(categoryId, productId) {
            const category = state.categories.find(c => c.id == categoryId);
            if (!category) return;
            const product = category.products.find(p => p.id == productId);
            if (product) {
                product.unit = product.unit === 'item' ? 'package' : 'item';
                saveState();
                renderCategories();
            }
        }

        // Task List Toggle
        function toggleTaskList(listId) {
            const index = expandedTaskLists.indexOf(listId);
            if (index === -1) {
                expandedTaskLists.push(listId);
            } else {
                expandedTaskLists.splice(index, 1);
            }
            renderTaskLists();
        }

        // Task Functions (only toggle allowed)
        function toggleTask(listId, taskId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            const task = taskList.tasks.find(t => t.id === taskId);
            task.done = !task.done;
            saveState();
            renderTaskLists();
        }

        function resetAllTasks(listId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            if (taskList) {
                taskList.tasks.forEach(t => t.done = false);
                saveState();
                renderTaskLists();
            }
        }

        function getTaskListProgress(taskList) {
            if (taskList.tasks.length === 0) return { completed: 0, total: 0, percent: 0 };
            const completed = taskList.tasks.filter(t => t.done).length;
            return {
                completed,
                total: taskList.tasks.length,
                percent: Math.round((completed / taskList.tasks.length) * 100)
            };
        }

        // Inventory Sharing
        function shareInventory() {
            if (state.categories.length === 0) {
                alert('No inventory to share!');
                return;
            }

            let inventoryText = `INVENTORY STATUS\n${new Date().toLocaleDateString()}\n${'═'.repeat(25)}\n`;

            state.categories.forEach(category => {
                inventoryText += `\n${category.name.toUpperCase()}\n${'─'.repeat(20)}\n`;
                if (category.products.length === 0) {
                    inventoryText += `  (No products)\n`;
                } else {
                    category.products.forEach(product => {
                        const status = getStockStatus(product.quantity);
                        const unitLabel = (product.unit || 'item') === 'package' ? 'pkg' : 'item';
                        inventoryText += `${product.name}: ${product.quantity} ${unitLabel} (${status.label})\n`;
                    });
                }
            });

            // Add summary of items that need ordering
            const orderItems = [];
            state.categories.forEach(category => {
                category.products.forEach(product => {
                    if (product.quantity > 0) {
                        const unitLabel = (product.unit || 'item') === 'package' ? 'pkg' : 'item';
                        orderItems.push(`${product.name} x${product.quantity} (${unitLabel})`);
                    }
                });
            });

            if (orderItems.length > 0) {
                inventoryText += `\n${'═'.repeat(25)}\nNEEDS ORDERING:\n`;
                orderItems.forEach(item => {
                    inventoryText += `- ${item}\n`;
                });
            }

            document.getElementById('share-text').textContent = inventoryText;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        // Task Sharing
        function shareTaskList(listId) {
            const taskList = state.taskLists.find(l => l.id === listId);
            if (!taskList || taskList.tasks.length === 0) {
                alert('No tasks to share in this list!');
                return;
            }

            const progress = getTaskListProgress(taskList);
            let taskText = `${taskList.name.toUpperCase()}\n${new Date().toLocaleDateString()}\n${'─'.repeat(20)}\n\n`;
            taskList.tasks.forEach(task => {
                const status = task.done ? '[x]' : '[ ]';
                taskText += `${status} ${task.text}\n`;
            });

            taskText += `\n${'─'.repeat(20)}\nProgress: ${progress.completed}/${progress.total} completed (${progress.percent}%)`;

            document.getElementById('share-text').textContent = taskText;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function shareAllTasks() {
            if (state.taskLists.length === 0) {
                alert('No task lists available!');
                return;
            }

            const container = document.getElementById('task-list-checkboxes');
            container.innerHTML = state.taskLists.map(taskList => {
                const progress = getTaskListProgress(taskList);
                return `
                    <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="share-list-${taskList.id}" value="${taskList.id}" checked
                               class="w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                        <div class="flex-1">
                            <div class="font-medium">${taskList.name}</div>
                            <div class="text-sm text-gray-500">${progress.total} tasks (${progress.completed} done)</div>
                        </div>
                    </label>
                `;
            }).join('');

            document.getElementById('select-tasks-modal').classList.remove('hidden');
        }

        function closeSelectModal() {
            document.getElementById('select-tasks-modal').classList.add('hidden');
        }

        function shareSelectedTasks() {
            const checkboxes = document.querySelectorAll('#task-list-checkboxes input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedIds.length === 0) {
                alert('Please select at least one task list to share!');
                return;
            }

            const selectedLists = state.taskLists.filter(l => selectedIds.includes(l.id));

            let taskText = `DAILY TASKS\n${new Date().toLocaleDateString()}\n${'═'.repeat(25)}\n`;

            selectedLists.forEach(taskList => {
                const progress = getTaskListProgress(taskList);
                taskText += `\n${taskList.name.toUpperCase()}\n${'─'.repeat(20)}\n`;
                if (taskList.tasks.length === 0) {
                    taskText += `  (No tasks)\n`;
                } else {
                    taskList.tasks.forEach(task => {
                        const status = task.done ? '[x]' : '[ ]';
                        taskText += `${status} ${task.text}\n`;
                    });
                    taskText += `Progress: ${progress.completed}/${progress.total} (${progress.percent}%)\n`;
                }
            });

            closeSelectModal();
            document.getElementById('share-text').textContent = taskText;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
        }

        function copyTaskList() {
            const text = document.getElementById('share-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Task list copied to clipboard!');
            });
        }

        function shareTasksWhatsApp() {
            const text = encodeURIComponent(document.getElementById('share-text').textContent);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function shareTasksEmail() {
            const text = encodeURIComponent(document.getElementById('share-text').textContent);
            const subject = encodeURIComponent(`Daily Tasks - ${new Date().toLocaleDateString()}`);
            window.open(`mailto:?subject=${subject}&body=${text}`, '_blank');
        }

        // Render Functions (View Only - no edit controls)
        function renderCategories() {
            const container = document.getElementById('categories-container');

            if (state.categories.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 bg-white rounded-lg shadow">No inventory items yet.</p>';
                return;
            }

            container.innerHTML = state.categories.map(category => {
                const isExpanded = expandedCategories.includes(category.id);
                const itemsNeedingOrder = category.products.filter(p => p.quantity > 0).length;
                return `
                <div class="bg-white rounded-lg shadow mb-3" style="max-width: 100%; overflow: hidden;">
                    <div class="bg-gray-800 text-white px-2 py-2 flex justify-between items-center cursor-pointer" dir="rtl" onclick="toggleCategory(${category.id})">
                        <div class="flex items-center gap-1">
                            <span class="transition-transform ${isExpanded ? 'rotate-90' : ''}">&gt;</span>
                            <h3 class="font-bold text-sm">${category.name}</h3>
                            ${itemsNeedingOrder > 0 ? `<span class="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full">${itemsNeedingOrder}</span>` : ''}
                        </div>
                        <button onclick="event.stopPropagation(); resetCategory(${category.id})" class="text-green-300 hover:text-green-100 text-xs">
                            Reset
                        </button>
                    </div>
                    <div class="${isExpanded ? '' : 'hidden'} p-2" style="max-width: 100%; overflow: hidden;">
                        <div class="divide-y">
                            ${category.products.map(product => {
                                const status = getStockStatus(product.quantity);
                                const needsOrder = product.quantity > 0;
                                const unit = product.unit || 'item';
                                const unitLabel = unit === 'package' ? 'pkg' : 'item';
                                return `
                                <div class="product-row flex items-center justify-between py-2 gap-2" dir="rtl">
                                    <span class="product-name ${needsOrder ? 'text-red-500 font-medium' : ''}">${product.name}</span>
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleProductUnit(${category.id}, ${product.id})"
                                                class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200">
                                            ${unitLabel}
                                        </button>
                                        <div class="flex items-center">
                                            <button ontouchstart="handleQtyTouchStart(event, ${category.id}, ${product.id}, false)"
                                                    ontouchend="handleQtyTouchEnd(event, ${category.id}, ${product.id}, false)"
                                                    onclick="return false"
                                                    class="qty-btn w-8 h-8 rounded-l-lg bg-gray-200 hover:bg-gray-300 font-bold text-lg">
                                                -
                                            </button>
                                            <span class="w-10 h-8 flex items-center justify-center bg-gray-100 font-medium text-sm">
                                                ${product.quantity}
                                            </span>
                                            <button ontouchstart="handleQtyTouchStart(event, ${category.id}, ${product.id}, true)"
                                                    ontouchend="handleQtyTouchEnd(event, ${category.id}, ${product.id}, true)"
                                                    onclick="return false"
                                                    class="qty-btn w-8 h-8 rounded-r-lg bg-gray-200 hover:bg-gray-300 font-bold text-lg">
                                                +
                                            </button>
                                        </div>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${status.color}">
                                            ${status.label}
                                        </span>
                                    </div>
                                </div>
                            `}).join('')}
                            ${category.products.length === 0 ? '<p class="text-gray-400 text-sm py-2">No products</p>' : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function renderTaskLists() {
            const container = document.getElementById('task-lists-container');

            if (state.taskLists.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 bg-white rounded-lg shadow">No task lists available.</p>';
                return;
            }

            container.innerHTML = state.taskLists.map(taskList => {
                const progress = getTaskListProgress(taskList);
                const isExpanded = expandedTaskLists.includes(taskList.id);
                const color = taskListColors[taskList.color] || taskListColors.blue;
                return `
                <div class="bg-white rounded-lg shadow mb-4 overflow-hidden">
                    <div class="${color.bg} text-white px-4 py-3 cursor-pointer" onclick="toggleTaskList(${taskList.id})">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="transition-transform ${isExpanded ? 'rotate-90' : ''}">&gt;</span>
                                <h3 class="font-bold">${taskList.name}</h3>
                            </div>
                            <span class="${color.text} text-sm">${progress.completed}/${progress.total}</span>
                        </div>
                        ${progress.total > 0 ? `
                        <div class="mt-2 ${color.progress} rounded-full h-2">
                            <div class="bg-white rounded-full h-2 transition-all" style="width: ${progress.percent}%"></div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="${isExpanded ? '' : 'hidden'} p-3">
                        <div class="divide-y">
                            ${taskList.tasks.map(task => `
                                <div class="flex items-center gap-3 py-2 ${task.done ? 'opacity-60' : ''}" dir="rtl">
                                    <input type="checkbox" ${task.done ? 'checked' : ''}
                                           onchange="toggleTask(${taskList.id}, ${task.id})"
                                           class="w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500 cursor-pointer">
                                    <span class="flex-1 text-right ${task.done ? 'line-through text-gray-400' : ''}">${task.text}</span>
                                </div>
                            `).join('')}
                            ${taskList.tasks.length === 0 ? '<p class="text-gray-400 text-sm py-2">No tasks</p>' : ''}
                        </div>
                        ${taskList.tasks.length > 0 ? `
                        <div class="mt-3 pt-3 border-t flex gap-2">
                            <button onclick="resetAllTasks(${taskList.id})" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg text-sm hover:bg-gray-200">
                                Reset All
                            </button>
                            <button onclick="shareTaskList(${taskList.id})" class="flex-1 bg-emerald-100 text-emerald-700 py-2 rounded-lg text-sm hover:bg-emerald-200">
                                Share This List
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        function renderAll() {
            renderCategories();
            renderTaskLists();
        }

        // Close modals on backdrop click
        document.getElementById('select-tasks-modal').addEventListener('click', (e) => {
            if (e.target.id === 'select-tasks-modal') closeSelectModal();
        });

        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.id === 'share-modal') closeShareModal();
        });

        // =====================================================
        // EMPLOYEE SCHEDULE AVAILABILITY SYSTEM
        // =====================================================

        // Schedule Configuration
        const scheduleDays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const scheduleDayLabelsHe = {
            sunday: 'ראשון', monday: 'שני', tuesday: 'שלישי',
            wednesday: 'רביעי', thursday: 'חמישי', friday: 'שישי', saturday: 'שבת'
        };
        const scheduleShifts = ['morning', 'afternoon', 'evening'];
        const scheduleShiftLabelsHe = { morning: 'בוקר', afternoon: 'צהריים', evening: 'ערב' };

        // Default shift hours
        const scheduleDefaultShiftHours = {
            morning: { start: '06:30', end: '12:30' },
            afternoon: { start: '12:30', end: '16:30' },
            evening: { start: '16:30', end: '20:30' }
        };

        // Schedule State
        let scheduleCurrentWeekStart = null;
        let scheduleEmployees = [];
        let scheduleSelectedEmployeeId = null;
        let scheduleAvailability = {};
        let scheduleShiftHours = { ...scheduleDefaultShiftHours };
        let scheduleModalDay = null;
        let scheduleModalShift = null;
        let scheduleInitialized = false;

        function scheduleGetWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function scheduleFormatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function scheduleGetWeekId() {
            return scheduleFormatDate(scheduleCurrentWeekStart);
        }

        function scheduleFormatTime(time) {
            if (!time) return '';
            const [h, m] = time.split(':');
            return `${parseInt(h)}:${m}`;
        }

        // Initialize availability grid
        function scheduleInitAvailability() {
            scheduleAvailability = {};
            scheduleDays.forEach(day => {
                scheduleAvailability[day] = {
                    morning: { available: false, customHours: null },
                    afternoon: { available: false, customHours: null },
                    evening: { available: false, customHours: null }
                };
            });
        }

        // Load shift hours from Firebase config
        async function scheduleLoadShiftHours() {
            try {
                const doc = await db.collection('employee-schedules').doc('config').get();
                if (doc.exists && doc.data().shiftHours) {
                    scheduleShiftHours = doc.data().shiftHours;
                }
            } catch (error) {
                console.error('Error loading shift hours:', error);
            }
        }

        // Load employees from Firebase
        async function scheduleLoadEmployees() {
            try {
                const doc = await db.collection('employee-schedules').doc('config').get();
                if (doc.exists && doc.data().employees) {
                    scheduleEmployees = doc.data().employees;
                } else {
                    scheduleEmployees = [];
                }
                scheduleRenderEmployeeDropdown();
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        function scheduleRenderEmployeeDropdown() {
            const select = document.getElementById('schedule-employee-select');
            select.innerHTML = '<option value="">-- Choose your name --</option>';
            scheduleEmployees.forEach(emp => {
                select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
            });
        }

        // Load my availability for selected week
        async function scheduleLoadMyAvailability() {
            const select = document.getElementById('schedule-employee-select');
            scheduleSelectedEmployeeId = select.value;

            document.getElementById('schedule-submit-btn').disabled = !scheduleSelectedEmployeeId;

            if (!scheduleSelectedEmployeeId) {
                scheduleInitAvailability();
                scheduleRenderAvailabilityGrid();
                scheduleRenderMyShifts();
                return;
            }

            try {
                const weekId = scheduleGetWeekId();
                const doc = await db.collection('employee-schedules').doc(weekId).get();

                if (doc.exists && doc.data().availability && doc.data().availability[scheduleSelectedEmployeeId]) {
                    const loadedAvail = doc.data().availability[scheduleSelectedEmployeeId];
                    scheduleAvailability = {};
                    scheduleDays.forEach(day => {
                        scheduleAvailability[day] = {};
                        scheduleShifts.forEach(shift => {
                            const val = loadedAvail[day]?.[shift];
                            if (typeof val === 'boolean') {
                                scheduleAvailability[day][shift] = { available: val, customHours: null };
                            } else if (val && typeof val === 'object') {
                                scheduleAvailability[day][shift] = val;
                            } else {
                                scheduleAvailability[day][shift] = { available: false, customHours: null };
                            }
                        });
                    });
                } else {
                    scheduleInitAvailability();
                }

                scheduleRenderAvailabilityGrid();
                scheduleRenderMyShifts(doc.exists ? doc.data() : null);
            } catch (error) {
                console.error('Error loading availability:', error);
                scheduleInitAvailability();
                scheduleRenderAvailabilityGrid();
            }
        }

        // Open modal to set hours for a shift
        function scheduleOpenShiftModal(day, shift) {
            if (!scheduleSelectedEmployeeId) return;

            scheduleModalDay = day;
            scheduleModalShift = shift;

            const shiftData = scheduleAvailability[day][shift];
            const defaultHours = scheduleShiftHours[shift];

            document.getElementById('schedule-modal-title').textContent = `${scheduleDayLabelsHe[day]} - ${scheduleShiftLabelsHe[shift]}`;

            if (shiftData.customHours) {
                document.getElementById('schedule-modal-start').value = shiftData.customHours.start;
                document.getElementById('schedule-modal-end').value = shiftData.customHours.end;
                document.getElementById('schedule-modal-full-shift').checked = false;
            } else {
                document.getElementById('schedule-modal-start').value = defaultHours.start;
                document.getElementById('schedule-modal-end').value = defaultHours.end;
                document.getElementById('schedule-modal-full-shift').checked = true;
            }

            document.getElementById('schedule-hours-modal').classList.add('show');
        }

        function scheduleCloseModal() {
            document.getElementById('schedule-hours-modal').classList.remove('show');
            scheduleModalDay = null;
            scheduleModalShift = null;
        }

        function scheduleSaveHours() {
            if (!scheduleModalDay || !scheduleModalShift) return;

            const fullShift = document.getElementById('schedule-modal-full-shift').checked;
            const startTime = document.getElementById('schedule-modal-start').value;
            const endTime = document.getElementById('schedule-modal-end').value;

            scheduleAvailability[scheduleModalDay][scheduleModalShift] = {
                available: true,
                customHours: fullShift ? null : { start: startTime, end: endTime }
            };

            scheduleCloseModal();
            scheduleRenderAvailabilityGrid();
        }

        function scheduleRemoveAvailability() {
            if (!scheduleModalDay || !scheduleModalShift) return;

            scheduleAvailability[scheduleModalDay][scheduleModalShift] = {
                available: false,
                customHours: null
            };

            scheduleCloseModal();
            scheduleRenderAvailabilityGrid();
        }

        // Toggle shift availability
        function scheduleToggleShift(day, shift) {
            if (!scheduleSelectedEmployeeId) return;

            const current = scheduleAvailability[day][shift];
            if (current.available) {
                scheduleOpenShiftModal(day, shift);
            } else {
                scheduleAvailability[day][shift] = { available: true, customHours: null };
                scheduleRenderAvailabilityGrid();
            }
        }

        // Render the availability grid
        function scheduleRenderAvailabilityGrid() {
            const grid = document.getElementById('schedule-availability-grid');
            const weekStart = new Date(scheduleCurrentWeekStart);

            grid.innerHTML = scheduleDays.map((day, index) => {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + index);
                const dateStr = `${dayDate.getDate()}/${dayDate.getMonth() + 1}`;

                return `
                    <div class="day-card bg-white rounded-xl p-3 shadow">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-gray-800">${scheduleDayLabelsHe[day]}</span>
                            <span class="text-sm text-gray-500">${dateStr}</span>
                        </div>
                        <div class="flex gap-2">
                            ${scheduleShifts.map(shift => {
                                const shiftData = scheduleAvailability[day]?.[shift] || { available: false, customHours: null };
                                const isAvailable = shiftData.available;
                                const hasCustom = shiftData.customHours;
                                const hours = hasCustom ? shiftData.customHours : scheduleShiftHours[shift];
                                const hoursDisplay = `${scheduleFormatTime(hours.start)}-${scheduleFormatTime(hours.end)}`;

                                let btnClass = 'shift-btn flex-1 py-2 px-1 rounded-lg text-xs font-medium';
                                if (isAvailable) {
                                    btnClass += hasCustom ? ' shift-partial' : ' shift-available';
                                }

                                return `
                                    <button onclick="scheduleToggleShift('${day}', '${shift}')"
                                            class="${btnClass}"
                                            ${!scheduleSelectedEmployeeId ? 'disabled' : ''}>
                                        <div>${scheduleShiftLabelsHe[shift]}</div>
                                        <div class="text-[10px] opacity-75">${hoursDisplay}</div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render my assigned shifts
        function scheduleRenderMyShifts(weekData) {
            const container = document.getElementById('schedule-my-shifts');

            if (!scheduleSelectedEmployeeId) {
                container.innerHTML = '<p class="text-gray-400">Select your name to see your schedule</p>';
                return;
            }

            if (!weekData || !weekData.finalSchedule) {
                container.innerHTML = '<p class="text-gray-400">Schedule not published yet</p>';
                return;
            }

            const schedule = weekData.finalSchedule;
            let myShifts = [];

            scheduleDays.forEach(day => {
                if (schedule[day]) {
                    scheduleShifts.forEach(shift => {
                        if (schedule[day][shift]) {
                            ['isgav', 'frankfurt'].forEach(location => {
                                if (schedule[day][shift][location]?.includes(parseInt(scheduleSelectedEmployeeId))) {
                                    myShifts.push({
                                        day: scheduleDayLabelsHe[day],
                                        shift: scheduleShiftLabelsHe[shift],
                                        location: location === 'isgav' ? 'Isgav' : 'Frankfurt'
                                    });
                                }
                            });
                        }
                    });
                }
            });

            if (myShifts.length === 0) {
                container.innerHTML = '<p class="text-gray-400">No shifts assigned yet</p>';
                return;
            }

            container.innerHTML = myShifts.map(s => `
                <div class="flex justify-between items-center py-2 border-b last:border-0">
                    <span class="font-medium">${s.day}</span>
                    <span class="text-gray-600">${s.shift}</span>
                    <span class="text-blue-600 text-sm">${s.location}</span>
                </div>
            `).join('');
        }

        // Submit availability
        async function scheduleSubmitAvailability() {
            if (!scheduleSelectedEmployeeId) return;

            const btn = document.getElementById('schedule-submit-btn');
            const status = document.getElementById('schedule-status-message');

            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const weekId = scheduleGetWeekId();
                const docRef = db.collection('employee-schedules').doc(weekId);

                const doc = await docRef.get();
                const existingData = doc.exists ? doc.data() : {
                    weekStart: weekId,
                    availability: {},
                    finalSchedule: null
                };

                existingData.availability = existingData.availability || {};
                existingData.availability[scheduleSelectedEmployeeId] = scheduleAvailability;

                await docRef.set(existingData);

                status.textContent = 'Availability saved successfully!';
                status.className = 'mt-4 p-4 rounded-xl text-center font-medium bg-green-100 text-green-700';
                status.classList.remove('hidden');

                setTimeout(() => {
                    status.classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error('Error saving:', error);
                status.textContent = 'Error saving. Please try again.';
                status.className = 'mt-4 p-4 rounded-xl text-center font-medium bg-red-100 text-red-700';
                status.classList.remove('hidden');
            }

            btn.disabled = false;
            btn.textContent = 'Submit Availability';
        }

        // Change week
        function scheduleChangeWeek(direction) {
            scheduleCurrentWeekStart.setDate(scheduleCurrentWeekStart.getDate() + (direction * 7));
            scheduleUpdateWeekDisplay();
            scheduleLoadMyAvailability();
        }

        // Update week display
        function scheduleUpdateWeekDisplay() {
            const weekEnd = new Date(scheduleCurrentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            // Use DD/MM format to avoid RTL issues with Hebrew dates
            const startDay = scheduleCurrentWeekStart.getDate();
            const startMonth = scheduleCurrentWeekStart.getMonth() + 1;
            const endDay = weekEnd.getDate();
            const endMonth = weekEnd.getMonth() + 1;
            document.getElementById('schedule-week-label').textContent = 'Week Schedule';
            document.getElementById('schedule-week-dates').textContent = `${startDay}/${startMonth} - ${endDay}/${endMonth}`;
        }

        // Initialize schedule
        async function scheduleInit() {
            if (scheduleInitialized) return;
            scheduleInitialized = true;
            scheduleCurrentWeekStart = scheduleGetWeekStart(new Date());
            scheduleInitAvailability();
            scheduleUpdateWeekDisplay();
            await scheduleLoadShiftHours();
            await scheduleLoadEmployees();
            scheduleRenderAvailabilityGrid();
        }

        // =====================================================
        // END EMPLOYEE SCHEDULE AVAILABILITY SYSTEM
        // =====================================================

        // Initialize
        updateLocationUI();
        loadState();
    </script>
</body>
</html>
